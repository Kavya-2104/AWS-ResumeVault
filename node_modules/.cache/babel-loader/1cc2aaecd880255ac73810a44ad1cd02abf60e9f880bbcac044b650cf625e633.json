{"ast":null,"code":"import { Hub } from '@aws-amplify/core';\nimport { assertTokenProviderConfig, isTokenExpired, AMPLIFY_SYMBOL } from '@aws-amplify/core/internals/utils';\nimport { assertServiceError } from '../../../errors/utils/assertServiceError.mjs';\nimport { AuthError } from '../../../errors/AuthError.mjs';\n\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nclass TokenOrchestrator {\n  constructor() {\n    this.waitForInflightOAuth = async () => {};\n  }\n  setAuthConfig(authConfig) {\n    this.authConfig = authConfig;\n  }\n  setTokenRefresher(tokenRefresher) {\n    this.tokenRefresher = tokenRefresher;\n  }\n  setAuthTokenStore(tokenStore) {\n    this.tokenStore = tokenStore;\n  }\n  setWaitForInflightOAuth(waitForInflightOAuth) {\n    this.waitForInflightOAuth = waitForInflightOAuth;\n  }\n  getTokenStore() {\n    if (!this.tokenStore) {\n      throw new AuthError({\n        name: 'EmptyTokenStoreException',\n        message: 'TokenStore not set'\n      });\n    }\n    return this.tokenStore;\n  }\n  getTokenRefresher() {\n    if (!this.tokenRefresher) {\n      throw new AuthError({\n        name: 'EmptyTokenRefresherException',\n        message: 'TokenRefresher not set'\n      });\n    }\n    return this.tokenRefresher;\n  }\n  async getTokens(options) {\n    let tokens;\n    try {\n      assertTokenProviderConfig(this.authConfig?.Cognito);\n    } catch (_err) {\n      // Token provider not configured\n      return null;\n    }\n    await this.waitForInflightOAuth();\n    tokens = await this.getTokenStore().loadTokens();\n    const username = await this.getTokenStore().getLastAuthUser();\n    if (tokens === null) {\n      return null;\n    }\n    const idTokenExpired = !!tokens?.idToken && isTokenExpired({\n      expiresAt: (tokens.idToken?.payload?.exp ?? 0) * 1000,\n      clockDrift: tokens.clockDrift ?? 0\n    });\n    const accessTokenExpired = isTokenExpired({\n      expiresAt: (tokens.accessToken?.payload?.exp ?? 0) * 1000,\n      clockDrift: tokens.clockDrift ?? 0\n    });\n    if (options?.forceRefresh || idTokenExpired || accessTokenExpired) {\n      tokens = await this.refreshTokens({\n        tokens,\n        username\n      });\n      if (tokens === null) {\n        return null;\n      }\n    }\n    return {\n      accessToken: tokens?.accessToken,\n      idToken: tokens?.idToken,\n      signInDetails: tokens?.signInDetails\n    };\n  }\n  async refreshTokens({\n    tokens,\n    username\n  }) {\n    try {\n      const newTokens = await this.getTokenRefresher()({\n        tokens,\n        authConfig: this.authConfig,\n        username\n      });\n      await this.setTokens({\n        tokens: newTokens\n      });\n      Hub.dispatch('auth', {\n        event: 'tokenRefresh'\n      }, 'Auth', AMPLIFY_SYMBOL);\n      return newTokens;\n    } catch (err) {\n      return this.handleErrors(err);\n    }\n  }\n  handleErrors(err) {\n    assertServiceError(err);\n    if (err.message !== 'Network error') {\n      // TODO(v6): Check errors on client\n      this.clearTokens();\n    }\n    if (err.name.startsWith('NotAuthorizedException')) {\n      return null;\n    } else {\n      Hub.dispatch('auth', {\n        event: 'tokenRefresh_failure'\n      }, 'Auth', AMPLIFY_SYMBOL);\n      throw err;\n    }\n  }\n  async setTokens({\n    tokens\n  }) {\n    return this.getTokenStore().storeTokens(tokens);\n  }\n  async clearTokens() {\n    return this.getTokenStore().clearTokens();\n  }\n  getDeviceMetadata(username) {\n    return this.getTokenStore().getDeviceMetadata(username);\n  }\n  clearDeviceMetadata(username) {\n    return this.getTokenStore().clearDeviceMetadata(username);\n  }\n}\nexport { TokenOrchestrator };","map":{"version":3,"names":["TokenOrchestrator","constructor","waitForInflightOAuth","setAuthConfig","authConfig","setTokenRefresher","tokenRefresher","setAuthTokenStore","tokenStore","setWaitForInflightOAuth","getTokenStore","AuthError","name","message","getTokenRefresher","getTokens","options","tokens","assertTokenProviderConfig","Cognito","_err","loadTokens","username","getLastAuthUser","idTokenExpired","idToken","isTokenExpired","expiresAt","payload","exp","clockDrift","accessTokenExpired","accessToken","forceRefresh","refreshTokens","signInDetails","newTokens","setTokens","Hub","dispatch","event","AMPLIFY_SYMBOL","err","handleErrors","assertServiceError","clearTokens","startsWith","storeTokens","getDeviceMetadata","clearDeviceMetadata"],"sources":["E:\\CSC-PROJECT\\amplify-react-app\\node_modules\\@aws-amplify\\auth\\src\\providers\\cognito\\tokenProvider\\TokenOrchestrator.ts"],"sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nimport { Hub, } from '@aws-amplify/core';\nimport { AMPLIFY_SYMBOL, assertTokenProviderConfig, isTokenExpired, } from '@aws-amplify/core/internals/utils';\nimport { assertServiceError } from '../../../errors/utils/assertServiceError';\nimport { AuthError } from '../../../errors/AuthError';\nexport class TokenOrchestrator {\n    constructor() {\n        this.waitForInflightOAuth = async () => { };\n    }\n    setAuthConfig(authConfig) {\n        this.authConfig = authConfig;\n    }\n    setTokenRefresher(tokenRefresher) {\n        this.tokenRefresher = tokenRefresher;\n    }\n    setAuthTokenStore(tokenStore) {\n        this.tokenStore = tokenStore;\n    }\n    setWaitForInflightOAuth(waitForInflightOAuth) {\n        this.waitForInflightOAuth = waitForInflightOAuth;\n    }\n    getTokenStore() {\n        if (!this.tokenStore) {\n            throw new AuthError({\n                name: 'EmptyTokenStoreException',\n                message: 'TokenStore not set',\n            });\n        }\n        return this.tokenStore;\n    }\n    getTokenRefresher() {\n        if (!this.tokenRefresher) {\n            throw new AuthError({\n                name: 'EmptyTokenRefresherException',\n                message: 'TokenRefresher not set',\n            });\n        }\n        return this.tokenRefresher;\n    }\n    async getTokens(options) {\n        let tokens;\n        try {\n            assertTokenProviderConfig(this.authConfig?.Cognito);\n        }\n        catch (_err) {\n            // Token provider not configured\n            return null;\n        }\n        await this.waitForInflightOAuth();\n        tokens = await this.getTokenStore().loadTokens();\n        const username = await this.getTokenStore().getLastAuthUser();\n        if (tokens === null) {\n            return null;\n        }\n        const idTokenExpired = !!tokens?.idToken &&\n            isTokenExpired({\n                expiresAt: (tokens.idToken?.payload?.exp ?? 0) * 1000,\n                clockDrift: tokens.clockDrift ?? 0,\n            });\n        const accessTokenExpired = isTokenExpired({\n            expiresAt: (tokens.accessToken?.payload?.exp ?? 0) * 1000,\n            clockDrift: tokens.clockDrift ?? 0,\n        });\n        if (options?.forceRefresh || idTokenExpired || accessTokenExpired) {\n            tokens = await this.refreshTokens({\n                tokens,\n                username,\n            });\n            if (tokens === null) {\n                return null;\n            }\n        }\n        return {\n            accessToken: tokens?.accessToken,\n            idToken: tokens?.idToken,\n            signInDetails: tokens?.signInDetails,\n        };\n    }\n    async refreshTokens({ tokens, username, }) {\n        try {\n            const newTokens = await this.getTokenRefresher()({\n                tokens,\n                authConfig: this.authConfig,\n                username,\n            });\n            await this.setTokens({ tokens: newTokens });\n            Hub.dispatch('auth', { event: 'tokenRefresh' }, 'Auth', AMPLIFY_SYMBOL);\n            return newTokens;\n        }\n        catch (err) {\n            return this.handleErrors(err);\n        }\n    }\n    handleErrors(err) {\n        assertServiceError(err);\n        if (err.message !== 'Network error') {\n            // TODO(v6): Check errors on client\n            this.clearTokens();\n        }\n        if (err.name.startsWith('NotAuthorizedException')) {\n            return null;\n        }\n        else {\n            Hub.dispatch('auth', { event: 'tokenRefresh_failure' }, 'Auth', AMPLIFY_SYMBOL);\n            throw err;\n        }\n    }\n    async setTokens({ tokens }) {\n        return this.getTokenStore().storeTokens(tokens);\n    }\n    async clearTokens() {\n        return this.getTokenStore().clearTokens();\n    }\n    getDeviceMetadata(username) {\n        return this.getTokenStore().getDeviceMetadata(username);\n    }\n    clearDeviceMetadata(username) {\n        return this.getTokenStore().clearDeviceMetadata(username);\n    }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}